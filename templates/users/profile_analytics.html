{% extends "base.html" %}
{% load static %}

{% block title %}–ú–æ–π –æ–±–∑–æ—Ä{% endblock %}

{% block content %}

<h1 class="mb-4">–ú–æ–π –æ–±–∑–æ—Ä</h1>

<!-- ===== –ë–õ–û–ö 1. –ú–û–Ø –ê–ö–¢–ò–í–ù–û–°–¢–¨ ===== -->
<h3>–ú–æ—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>

<div class="row mb-5">
  <div class="col-md-4">
    <div class="profile-kpi-card">
      <div class="profile-kpi-value">{{ total_downloads }}</div>
      <div class="profile-kpi-label">–°–∫–∞—á–∞–Ω–æ –∫–Ω–∏–≥</div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="profile-kpi-card">
      <div class="profile-kpi-value">{{ favorites_count }}</div>
      <div class="profile-kpi-label">–í –∏–∑–±—Ä–∞–Ω–Ω–æ–º</div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="profile-kpi-card">
      <div class="profile-kpi-value">{{ active_days }}</div>
      <div class="profile-kpi-label">–î–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>
    </div>
  </div>
</div>

<!-- ===== –õ—é–±–∏–º—ã–π –∞–≤—Ç–æ—Ä ===== -->
{% if favorite_author %}
<div class="profile-favorite-author-box mb-5">
  <div class="profile-favorite-author-label">–í–∞—à –ª—é–±–∏–º—ã–π –∞–≤—Ç–æ—Ä</div>
  <a href="{% url 'books:author_detail' favorite_author.book__authors__slug %}"
     class="profile-favorite-author-name">
    {{ favorite_author.book__authors__name }}
  </a>
</div>
{% endif %}

<!-- ===== –õ–Æ–ë–ò–ú–´–ï –§–û–†–ú–ê–¢–´ –ö–ù–ò–ì ===== -->
<h3 class="mt-5 mb-3">üìö –õ—é–±–∏–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –∫–Ω–∏–≥</h3>

<div class="row mb-5">
  <div class="col-md-4">
    <div class="profile-kpi-card">
      <div class="profile-kpi-value">{{ formats_map.pdf }}</div>
      <div class="profile-kpi-label">PDF</div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="profile-kpi-card">
      <div class="profile-kpi-value">{{ formats_map.epub }}</div>
      <div class="profile-kpi-label">EPUB</div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="profile-kpi-card">
      <div class="profile-kpi-value">{{ formats_map.fb2 }}</div>
      <div class="profile-kpi-label">FB2</div>
    </div>
  </div>
</div>

<!-- ===== –ú–û–Ø –î–ò–ù–ê–ú–ò–ö–ê –ß–¢–ï–ù–ò–Ø ===== -->
<h3 class="mt-5 mb-3">üìà –ú–æ—è –¥–∏–Ω–∞–º–∏–∫–∞ —á—Ç–µ–Ω–∏—è</h3>

<div class="card mb-5 shadow-sm">
  <div class="card-body">
    <canvas id="readingChart" height="120"></canvas>
  </div>
</div>

<!-- ===== –ë–õ–û–ö 3. –†–ï–ö–û–ú–ï–ù–î–û–í–ê–ù–ù–´–ï –ö–ù–ò–ì–ò ===== -->
<h3 class="mt-5 mb-3">–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∞—Å –∫–Ω–∏–≥–∏</h3>

<div class="row mb-5">
  {% for book in recommended_books %}
    {% include 'books/includes/book_card.html' with book=book show_author=True show_stats=True show_views=True button_class="btn-primary btn-sm" %}
  {% empty %}
    <p class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.</p>
  {% endfor %}
</div>

<!-- ===== –ë–õ–û–ö 4. –ú–û–ò –õ–Æ–ë–ò–ú–´–ï –ñ–ê–ù–†–´ ===== -->
<h3 class="mt-5">–ú–æ–∏ –ª—é–±–∏–º—ã–µ –∂–∞–Ω—Ä—ã</h3>

<table class="table table-sm align-middle">
  <thead class="thead-light">
    <tr>
      <th>#</th>
      <th>–ñ–∞–Ω—Ä</th>
      <th class="text-end">–°–∫–∞—á–∏–≤–∞–Ω–∏–π</th>
    </tr>
  </thead>
  <tbody>
    {% for g in favorite_genres %}
    <tr>
      <td>{{ forloop.counter }}</td>
      <td>
        <a href="{% url 'books:genre_detail' g.book__genres__slug %}">
          {{ g.book__genres__name }}
        </a>
      </td>
      <td class="text-end fw-bold">{{ g.cnt }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- –ì–†–ê–§–ò–ö –ñ–ê–ù–†–û–í -->
<div class="profile-chart-box">
  <canvas id="genresChart"></canvas>
</div>


<!-- ===== Chart.js ===== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
{% if favorite_genres %}
const genresLabels = [
  {% for g in favorite_genres %}
    "{{ g.book__genres__name }}",
  {% endfor %}
];

const genresData = [
  {% for g in favorite_genres %}
    {{ g.cnt }},
  {% endfor %}
];

const genresCtx = document.getElementById('genresChart');

if (genresCtx) {
  new Chart(genresCtx, {
    type: 'doughnut',
    data: {
      labels: genresLabels,
      datasets: [{
        data: genresData,
        backgroundColor: [
          '#0d6efd',
          '#198754',
          '#ffc107',
          '#dc3545',
          '#6f42c1'
        ],
        borderWidth: 2,
        hoverOffset: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });
}
{% endif %}
</script>

<script>
const readingCtx = document.getElementById('readingChart');

if (readingCtx) {
  const labels = {{ reading_months|safe }};
  const data = {{ reading_counts|safe }};

  if (labels.length > 0) {
    new Chart(readingCtx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          borderColor: '#0d6efd',
          backgroundColor: 'rgba(13, 110, 253, 0.25)',
          fill: true,
          tension: 0.4,
          pointRadius: 6,
          pointHoverRadius: 8,
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }
}
</script>

{% endblock %}
