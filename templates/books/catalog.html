{% extends "base.html" %}
{% load static %}

{% block title %}–ö–∞—Ç–∞–ª–æ–≥{% endblock %}

{% block content %}


<div class="catalog-row">

  <!-- ===== –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –§–ò–õ–¨–¢–†–´ ===== -->
  <div class="catalog-col-left">
{% if selected_genres or selected_authors or search %}
  <div class="found-books mb-4">
    üìö –ù–∞–π–¥–µ–Ω–æ –∫–Ω–∏–≥: <strong>{{ page_obj.paginator.count }}</strong>
  </div>
{% endif %}
    <form method="get">
      <input type="hidden" name="sort" value="{{ sort }}">

      <!-- –ñ–ê–ù–†–´ -->
      <div class="mb-3">
  <strong>–ß—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ—á–µ—Å—Ç—å?</strong>
        <input
  type="text"
  class="search-input mb-2"
  placeholder="–ü–æ–∏—Å–∫ –∂–∞–Ω—Ä–∞..."
  onkeyup="filterCheckboxes(this, 'genres-list')"
>

  <div id="genres-list" class="filter-list" style="overflow-y: hidden;">
    {% for genre in genres %}
      <div class="form-check filter-item">
        <input
  class="form-check-input"
  type="checkbox"
  name="genres"
  value="{{ genre.slug }}"
  onchange="this.form.submit()"
  {% if genre.slug in selected_genres %}checked{% endif %}
  {% if genre not in available_genres and genre.slug not in selected_genres %}
    disabled
  {% endif %}
>
        <label class="form-check-label
  {% if genre not in available_genres and genre.slug not in selected_genres %}
    text-muted
  {% endif %}
">
  {{ genre.name }}
</label>
      </div>
    {% endfor %}
  </div>

  {% if genres|length > 8 %}
  <button type="button"
          class="show-toggle"
          onclick="toggleFilter('genres-list', this)">
    –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ
  </button>
  {% endif %}
</div>


      <!-- –ê–í–¢–û–†–´ -->
      <div class="mb-3">
  <strong>–ö–∞–∫–æ–≥–æ –∞–≤—Ç–æ—Ä–∞ –≤—ã–±–µ—Ä–µ–º?</strong>
        <input
  type="text"
  class="search-input mb-2"
  placeholder="–ü–æ–∏—Å–∫ –∞–≤—Ç–æ—Ä–∞..."
  onkeyup="filterCheckboxes(this, 'authors-list')"
>

  <div id="authors-list" class="filter-list" style="overflow-y: hidden;">
    {% for author in authors %}
      <div class="form-check filter-item">
        <input
  class="form-check-input"
  type="checkbox"
  name="authors"
  value="{{ author.slug }}"
  onchange="this.form.submit()"
  {% if author.slug in selected_authors %}checked{% endif %}
  {% if author not in available_authors and author.slug not in selected_authors %}
    disabled
  {% endif %}
>
        <label class="form-check-label
  {% if author not in available_authors and author.slug not in selected_authors %}
    text-muted
  {% endif %}
">
  {{ author.name }}
</label>
      </div>
    {% endfor %}
  </div>

  {% if authors|length > 8 %}
  <button type="button"
          class="show-toggle"
          onclick="toggleFilter('authors-list', this)">
    –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ
  </button>
{% endif %}
</div>

      <button type="submit" class="btn-new btn-new-dark w-100">
        –ü—Ä–∏–º–µ–Ω–∏—Ç—å
      </button>

    </form>
  </div>

  <!-- ===== –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –ö–ù–ò–ì–ò ===== -->
  <div class="catalog-col-right">
    <!-- ===== –°–û–†–¢–ò–†–û–í–ö–ê ===== -->
<form method="get" class="sort-form">

  {# —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã #}
  {% for g in selected_genres %}
    <input type="hidden" name="genres" value="{{ g }}">
  {% endfor %}

  {% for a in selected_authors %}
    <input type="hidden" name="authors" value="{{ a }}">
  {% endfor %}

  <label class="sort-label"><strong>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</strong></label>

  <select name="sort" class="sort-select" onchange="this.form.submit()">
    <option value="title" {% if sort == 'title' %}selected{% endif %}>
      –ü–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
    </option>
    <option value="new" {% if sort == 'new' %}selected{% endif %}>
      –ù–æ–≤–∏–Ω–∫–∏
    </option>
  </select>

</form>

{# ===== UX: –ü–†–ò–ú–ï–ù–ï–ù–´ –§–ò–õ–¨–¢–†–´ ===== #}
{% if search or selected_genres or selected_authors %}
  <div class="applied-filters mb-4">
    <strong>–ü—Ä–∏–º–µ–Ω–µ–Ω—ã —Ñ–∏–ª—å—Ç—Ä—ã:</strong>

    <ul>
      {% if search %}
        <li><strong>–ü–æ–∏—Å–∫:</strong> ¬´{{ search }}¬ª</li>
      {% endif %}
      {% if selected_genres %}
        <li><strong>–ñ–∞–Ω—Ä—ã:</strong> {% for g in selected_genre_objects %}{{ g.name }}{% if not forloop.last %}, {% endif %}{% endfor %}</li>
      {% endif %}
      {% if selected_authors %}
        <li><strong>–ê–≤—Ç–æ—Ä—ã:</strong> {% for a in selected_author_objects %}{{ a.name }}{% if not forloop.last %}, {% endif %}{% endfor %}</li>
      {% endif %}
    </ul>

    <a href="{% url 'books:catalog' %}" class="btn-new btn-new-dark btn-sm w-auto">
      –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã
    </a>
  </div>
{% endif %}

    {% if page_obj.object_list %}
      <div class="books-row">
        {% for book in page_obj.object_list %}
          {% include 'books/includes/book_card.html' with book=book show_author=True show_stats=True show_views=False %}
        {% endfor %}
      </div>

      <!-- ===== –ü–ê–ì–ò–ù–ê–¶–ò–Ø –° –°–û–•–†–ê–ù–ï–ù–ò–ï–ú –§–ò–õ–¨–¢–†–û–í ===== -->
      <nav>
        <ul class="pagination pagination-new">

          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link"
                 href="?page={{ page_obj.previous_page_number }}
                 {% for g in selected_genres %}&genres={{ g }}{% endfor %}
                 {% for a in selected_authors %}&authors={{ a }}{% endfor %}
                 {% if search %}&search={{ search }}{% endif %} &sort={{ sort }}">
                –ù–∞–∑–∞–¥
              </a>
            </li>
          {% endif %}

          <li class="page-item disabled">
            <span class="page-link">
              –°—Ç—Ä. {{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}
            </span>
          </li>

          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link"
                 href="?page={{ page_obj.next_page_number }}
                 {% for g in selected_genres %}&genres={{ g }}{% endfor %}
                 {% for a in selected_authors %}&authors={{ a }}{% endfor %}
                 {% if search %}&search={{ search }}{% endif %} &sort={{ sort }}">
                –í–ø–µ—Ä–µ–¥
              </a>
            </li>
          {% endif %}

        </ul>
      </nav>
    {% else %}
      <p>–ö–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>
    {% endif %}

  </div>
</div>

<script>
function toggleFilter(id, btn) {
    const block = document.getElementById(id);

    block.classList.toggle('expanded');

    if (block.classList.contains('expanded')) {
        btn.textContent = '–°–≤–µ—Ä–Ω—É—Ç—å';
    } else {
        btn.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ';
    }
}
</script>

<script>
function filterCheckboxes(input, listId) {
  const filter = input.value.toLowerCase();
  const list = document.getElementById(listId);
  const items = list.getElementsByClassName('filter-item');

  let visibleCount = 0;

  for (let item of items) {
    const label = item.innerText.toLowerCase();
    const isVisible = label.includes(filter);
    item.style.display = isVisible ? '' : 'none';
    if (isVisible) visibleCount++;
  }

  // –ª–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ"
  const btn = list.parentElement.querySelector('button');
  if (btn) {
    btn.style.display = visibleCount > 8 ? '' : 'none';
  }
}
</script>

{% endblock %}
