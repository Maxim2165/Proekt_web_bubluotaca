{% extends "base.html" %}
{% load static %}

{% block title %}{{ book.title }}{% endblock %}

{% block content %}


<div class="book-page">

  <div class="book-main">

    <!-- Названи-->
    <h1 class="book-title">{{ book.title }}</h1>

    <!-- Обложка и автор + статистика -->
    <div class="book-review">

      <!-- Обложка -->
      {% if book.cover %}
        <img src="{{ book.cover.url }}" alt="{{ book.title }}" class="book-image">
      {% else %}
        <div class="book-image placeholder">Нет обложки</div>
      {% endif %}

      <!-- Блок информации (автор + статистика) -->
      <div class="book-information">

        <!-- Автор -->
        <div class="author">
          {% for author in book.authors.all %}
            {% if author.photo %}
              <img src="{{ author.photo.url }}" alt="{{ author.name }}" class="author-photo">
            {% else %}
              <div class="author-photo placeholder">—</div>
            {% endif %}
            <div class="author-info">
              <a href="{% url 'books:author_detail' author.slug %}" class="author-name">
                {{ author.name }}
              </a>
            </div>
          {% empty %}
            <p class="text-muted">Автор не указан</p>
          {% endfor %}
        </div>

        <!-- Статистика -->
        <div class="bottom-information">
          <div class="genre">
            <div class="stat-label">Жанр</div>
            <div class="stat-value">
              {% for genre in book.genres.all %}
                <a href="{% url 'books:genre_detail' genre.slug %}" > {{ genre.name }}</a>{% if not forloop.last %}, {% endif %}
              {% empty %}
                Не указан
              {% endfor %}
            </div>
          </div>

          <div class="genre">
            <div class="stat-label">Скачиваний</div>
            <div class="stat-value">{{ download_count }}</div>
          </div>

          <div class="genre">
            <div class="stat-label">Просмотров</div>
            <div class="stat-value">{{ view_count }}</div>
          </div>
        </div>
      </div>
    </div>

    <p class="book-description">{{ book.description|linebreaksbr }}</p>

    <!-- Скачивание и избранное (общий блок для неавторизованных) -->
<div class="book-actions">
  {% if user.is_authenticated %}
    <!-- Скачивание -->
    <div class="download-section">
      <div class="download-title">Доступные форматы для скачивания:</div>
      <div class="download-buttons">
        {% if book.file_pdf %}
          <a href="{% url 'books:download' book.pk 'pdf' %}" class="btn-new btn-new-dark">PDF</a>
        {% endif %}
        {% if book.file_epub %}
          <a href="{% url 'books:download' book.pk 'epub' %}" class="btn-new btn-new-dark">EPUB</a>
        {% endif %}
        {% if book.file_fb2 %}
          <a href="{% url 'books:download' book.pk 'fb2' %}" class="btn-new btn-new-dark">FB2</a>
        {% endif %}
      </div>
    </div>

    <!-- Избранное -->
    <div class="book-favorite-section">
      <form method="post" action="{% url 'books:favorite_toggle' book.pk %}">
        {% csrf_token %}
        <input type="hidden" name="next" value="{{ request.get_full_path }}">
        {% if is_favorited %}
          <button type="submit" class="btn-new btn-new-dark">Убрать из избранного</button>
        {% else %}
          <button type="submit" class="btn-new btn-new-dark">Добавить в избранное</button>
        {% endif %}
      </form>
    </div>
  {% else %}
    <!-- Один текст для обоих действий -->
    <p class="login-text">
      <a href="{% url 'users:login' %}?next={{ request.get_full_path|urlencode }}">Войдите</a> /
      <a href="{% url 'users:register' %}?next={{ request.get_full_path|urlencode }}">Зарегистрируйтесь</a>,
      чтобы скачать или добавить в избранное книгу.
    </p>
  {% endif %}
</div>
  </div>

</div>

{% endblock %}