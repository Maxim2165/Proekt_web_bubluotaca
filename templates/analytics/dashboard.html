{% extends "base.html" %}
{% load static %}

{% block title %}–û–±–∑–æ—Ä —Å–∞–π—Ç–∞{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'analytics/css/dashboard.css' %}">

<h1 class="mb-4">üìä –û–±–∑–æ—Ä —Å–∞–π—Ç–∞</h1>

<!-- ================= KPI ================= -->
<div class="row mb-4">
  {% for icon, value, label in "" %}
  {% endfor %}
  <div class="col-md-3 mb-3">
    <div class="card text-center shadow-sm h-100">
      <div class="card-body">
        <h2>üìö</h2>
        <h3>{{ total_books }}</h3>
        <p class="text-muted small">–í—Å–µ–≥–æ –∫–Ω–∏–≥</p>
      </div>
    </div>
  </div>

  <div class="col-md-3 mb-3">
    <div class="card text-center shadow-sm h-100">
      <div class="card-body">
        <h2>üë•</h2>
        <h3>{{ total_authors }}</h3>
        <p class="text-muted small">–ê–≤—Ç–æ—Ä–æ–≤</p>
      </div>
    </div>
  </div>

  <div class="col-md-3 mb-3">
    <div class="card text-center shadow-sm h-100">
      <div class="card-body">
        <h2>üëÅ</h2>
        <h3>{{ total_views|floatformat:0 }}</h3>
        <p class="text-muted small">–ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</p>
      </div>
    </div>
  </div>

  <div class="col-md-3 mb-3">
    <div class="card text-center shadow-sm h-100">
      <div class="card-body">
        <h2>‚¨á</h2>
        <h3>{{ total_downloads }}</h3>
        <p class="text-muted small">–°–∫–∞—á–∏–≤–∞–Ω–∏–π</p>
      </div>
    </div>
  </div>
</div>

<!-- ================= –ö–ù–ò–ì–ê –ù–ï–î–ï–õ–ò ================= -->
{% if book_of_week %}
<div class="card mb-4 shadow-sm">
  <div class="card-body">
    <h4 class="mb-3">üìò –ö–Ω–∏–≥–∞ –Ω–µ–¥–µ–ª–∏</h4>

    <div class="row align-items-center">
      <div class="col-md-2">
        {% if book_of_week.cover %}
          <img src="{{ book_of_week.cover.url }}" class="img-fluid rounded">
        {% endif %}
      </div>

      <div class="col-md-10">
        <h5>
          <a href="{% url 'books:detail' book_of_week.pk %}">
            {{ book_of_week.title }}
          </a>
        </h5>

        <p class="book-week-author">
          {% for a in book_of_week.authors.all %}
            <a href="{% url 'books:author_detail' a.slug %}">
              {{ a.name }}
            </a>{% if not forloop.last %}, {% endif %}
          {% endfor %}
        </p>

        <p class="text-muted mb-2">
          üëÅ {{ book_of_week_stats.views }} |
          ‚¨á {{ book_of_week_stats.total_downloads }} |
          ‚¨á –∑–∞ 7 –¥–Ω–µ–π: {{ book_of_week_stats.weekly_downloads }}
        </p>

        <a href="{% url 'books:detail' book_of_week.pk %}" class="btn btn-sm btn-primary">
          –û—Ç–∫—Ä—ã—Ç—å –∫–Ω–∏–≥—É ‚Üí
        </a>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- ================= –¢–û–ü –ö–ù–ò–ì ================= -->
<div class="card mb-4">
  <div class="card-body">
    <h4 class="mb-3">üìö –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–Ω–∏–≥–∏ (–¢–û–ü-5)</h4>

    <div class="table-responsive">
      <table class="table table-hover align-middle analytics-table">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>–ö–Ω–∏–≥–∞</th>
            <th>üëÅ –ü—Ä–æ—Å–º–æ—Ç—Ä—ã</th>
            <th>‚¨á –°–∫–∞—á–∏–≤–∞–Ω–∏—è</th>
            <th>‚¨á –∑–∞ 7 –¥–Ω–µ–π</th>
            <th>‚≠ê –†–µ–π—Ç–∏–Ω–≥</th>
          </tr>
        </thead>
        <tbody>
          {% for book in top_books %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>
              <a href="{% url 'books:detail' book.pk %}">
                {{ book.title }}
              </a>
            </td>
            <td>{{ book.views_count }}</td>
            <td>{{ book.downloads_count }}</td>
            <td>
              <span class="badge bg-info">
                {{ book.weekly_downloads_count }}
              </span>
            </td>
            <td>
              <span class="badge bg-warning text-dark">
                {{ book.complex_score|floatformat:1 }}
              </span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="chart-wrapper books-chart-wrapper w-100">
  <canvas id="booksChart"></canvas>
    </div>
  </div>
</div>

<!-- ================= –¢–û–ü –ñ–ê–ù–†–û–í ================= -->
<div class="card mb-4">
  <div class="card-body">
    <h4>üé≠ –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∂–∞–Ω—Ä—ã (–¢–û–ü-5)</h4>

    <div class="table-responsive mb-3">
      <table class="table table-hover align-middle analytics-table">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>–ñ–∞–Ω—Ä</th>
            <th>üìö –ö–Ω–∏–≥</th>
            <th>üëÅ –ü—Ä–æ—Å–º–æ—Ç—Ä—ã</th>
            <th>‚¨á –°–∫–∞—á–∏–≤–∞–Ω–∏—è</th>
            <th>‚≠ê –†–µ–π—Ç–∏–Ω–≥</th>
          </tr>
        </thead>
        <tbody>
          {% for genre in top_genres %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>
              <a href="{% url 'books:genre_detail' genre.slug %}">
                {{ genre.name }}
              </a>
            </td>
            <td>{{ genre.books_count }}</td>
            <td>{{ genre.total_views|floatformat:0 }}</td>
            <td>{{ genre.total_downloads }}</td>
            <td>
              <span class="badge bg-warning text-dark">
                {{ genre.genre_score|floatformat:1 }}
              </span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="chart-wrapper">
      <canvas id="genresChart"></canvas>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const genresCanvas = document.getElementById('genresChart');
if (genresCanvas) {
  new Chart(genresCanvas, {
    type: 'doughnut',
    data: {
      labels: [{% for g in top_genres %}"{{ g.name }}",{% endfor %}],
      datasets: [{
        data: [{% for g in top_genres %}{{ g.total_downloads }},{% endfor %}]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });
}

const booksCanvas = document.getElementById('booksChart');
if (booksCanvas) {
  new Chart(booksCanvas, {
    type: 'bar',
    data: {
      labels: [{% for b in top_books %}"{{ b.title|truncatewords:3 }}",{% endfor %}],
      datasets: [
        {
          label: '–í—Å–µ–≥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π',
          data: [{% for b in top_books %}{{ b.downloads_count }},{% endfor %}],
          barPercentage: 0.9,
          categoryPercentage: 0.9
        },
        {
          label: '–ó–∞ 7 –¥–Ω–µ–π',
          data: [{% for b in top_books %}{{ b.weekly_downloads_count }},{% endfor %}],
          barPercentage: 0.9,
          categoryPercentage: 0.9
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          grid: { display: false },
          ticks: {
            autoSkip: false,
            maxRotation: 0,
            minRotation: 0
          }
        },
        y: {
          beginAtZero: true
        }
      },
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });
}
</script>

{% endblock %}
