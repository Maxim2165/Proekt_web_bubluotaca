{% extends "base.html" %}
{% load static %}

{% block title %}Обзор сайта{% endblock %}

{% block content %}

  <div class="dashboard-container">

    <!-- Заголовок + подзаголовок -->
    <p class="page-subtitle">
      Здесь собраны книги и авторы разных эпох и направлений. Представленные цифры отражают живое пространство литературы - количество голосов, историй и произведений, которые формируют библиотеку и продолжают находить своих читателей.
    </p>

    <!-- KPI -->
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-label">Всего книг</div>
        <div class="kpi-value">{{ total_books }}</div>
      </div>

      <div class="kpi-card">
        <div class="kpi-label">Всего авторов</div>
        <div class="kpi-value">{{ total_authors }}</div>
      </div>

      <div class="kpi-card">
        <div class="kpi-label">Посмотрели</div>
        <div class="kpi-value">{{ total_views|floatformat:0 }}</div>
      </div>

      <div class="kpi-card">
        <div class="kpi-label">Скачано трудов</div>
        <div class="kpi-value">{{ total_downloads }}</div>
      </div>
    </div>

    <!-- Книга недели и Книга читателей -->
    <div class="special-books">
      <div class="book-special-card">
        <div class="book-special-title">Книга недели</div>
        {% if book_of_week %}
          <div class="book-special-content">
            <img class="book-special-photo" src="{{ book_of_week.cover.url }}" alt="{{ book_of_week.title }}">
            <div class="book-special-info">
  <div class="book-special-book-title">{{ book_of_week.title }}</div>  <!-- ← без ссылки -->

  <div class="book-special-author">
    {% for a in book_of_week.authors.all %}
      <a href="{% url 'books:author_detail' a.slug %}" class="author-link">
        {{ a.name }}
      </a>{% if not forloop.last %}, {% endif %}
    {% endfor %}
  </div>
  <div class="book-special-stats">
    Посмотрели: {{ book_of_week.weekly_views }} | Скачали: {{ book_of_week.total_downloads }} | За 7 дней: {{ book_of_week.weekly_downloads }}
  </div>
  <div class="book-special-button">
    <a href="{% url 'books:detail' book_of_week.pk %}" class="btn-new btn-new-dark">
      Узнать о книге
    </a>
  </div>
</div>
          </div>
        {% else %}
          <p>На этой неделе нет книги недели.</p>
        {% endif %}
      </div>

      <div class="book-special-card">
  <div class="book-special-title">Книга признанная читателями</div>
  {% if readers_choice %}
    <div class="book-special-content">
      <img class="book-special-photo" src="{{ readers_choice.cover.url }}" alt="{{ readers_choice.title }}">
      <div class="book-special-info">
        <div class="book-special-book-title">{{ readers_choice.title }}</div>

        <div class="book-special-author">
          {% for a in readers_choice.authors.all %}
            <a href="{% url 'books:author_detail' a.slug %}" class="author-link">
              {{ a.name }}
            </a>{% if not forloop.last %}, {% endif %}
          {% endfor %}
        </div>

        <div class="book-special-stats">
          В избранном: {{ readers_choice.total_favorites }} | Просмотры: {{ readers_choice.total_views }} | Скачали: {{ readers_choice.total_downloads }}
        </div>

        <div class="book-special-button">
          <a href="{% url 'books:detail' readers_choice.pk %}" class="btn-new btn-new-dark">
            Узнать о книге
          </a>
        </div>
      </div>
    </div>
  {% else %}
    <p>Пока нет книги, признанной читателями.</p>
  {% endif %}
</div>
    </div>

    <!-- ТОП-5 книг -->
    <div class="top-section">
      <div class="top-title">Популярные книги (ТОП-5)</div>

      <table class="analytics-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Книга</th>
            <th>Просмотры</th>
            <th>Скачивания</th>
            <th>Избранное</th>
            <th>Рейтинг</th>
          </tr>
        </thead>
        <tbody>
          {% for book in top_books %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td><a href="{% url 'books:detail' book.pk %}">{{ book.title }}</a></td>
              <td>{{ book.total_views }}</td>
              <td>{{ book.total_downloads }}</td>
              <td>{{ book.total_favorites }}</td>
              <td>{{ book.score|floatformat:1 }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="chart-wrapper">
        <canvas id="booksChart"></canvas>
      </div>
    </div>

    <!-- ТОП-5 жанров -->
    <div class="top-section">
      <div class="top-title">Популярные жанры (ТОП-5)</div>

      <table class="analytics-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Жанр</th>
            <th>Книг</th>
            <th>Просмотры</th>
            <th>Скачивания</th>
            <th>Избранное</th>
            <th>Рейтинг</th>
          </tr>
        </thead>
        <tbody>
          {% for genre in top_genres %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td><a href="{% url 'books:genre_detail' genre.slug %}">{{ genre.name }}</a></td>
              <td>{{ genre.books_count }}</td>
              <td>{{ genre.total_views|floatformat:0 }}</td>
              <td>{{ genre.total_downloads }}</td>
              <td>{{ genre.total_favorites }}</td>
              <td>{{ genre.genre_score|floatformat:2 }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="chart-wrapper">
        <canvas id="genresChart"></canvas>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
  // График жанров
  const genresCanvas = document.getElementById('genresChart');
  if (genresCanvas) {
    new Chart(genresCanvas, {
      type: 'doughnut',
      data: {
        labels: [{% for g in top_genres %}"{{ g.name }}",{% endfor %}],
        datasets: [
  {
    label: 'Скачивания',
    data: [{% for g in top_genres %}{{ g.total_downloads }},{% endfor %}],
    backgroundColor: '#36A2EB'
  },
  {
    label: 'Избранное',
    data: [{% for g in top_genres %}{{ g.total_favorites }},{% endfor %}],
    backgroundColor: '#FFCE56'
  }
]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });
  }

  // График книг
const booksCanvas = document.getElementById('booksChart');
if (booksCanvas) {
  new Chart(booksCanvas, {
    type: 'bar',
    data: {
      labels: [{% for b in top_books %}"{{ b.title|truncatewords:3 }}",{% endfor %}],
      datasets: [
        {
          label: 'Всего скачиваний',
          data: [{% for b in top_books %}{{ b.total_downloads }},{% endfor %}],
          backgroundColor: '#36A2EB'
        },
        {
          label: 'Избранное',
          data: [{% for b in top_books %}{{ b.total_favorites }},{% endfor %}],
          backgroundColor: '#FFCE56'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { grid: { display: false } },
        y: { beginAtZero: true }
      },
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });
}
  </script>

{% endblock %}